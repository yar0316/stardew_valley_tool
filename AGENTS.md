# AGENTS.md

この文書は、本リポジトリ内で AI エージェント（Codex CLI）が作業する際の挙動・運用ルールを定義します。人間の開発者が読むことで、エージェントに依頼するタスクの期待値を共有できます。

## 基本方針

- 明確・簡潔・友好的に応答し、常に実行可能な次の一手を提示する。
- 英語でthinkし、日本語でoutputする。
- 変更は「最小差分・局所的・既存スタイル遵守」。無関係な修正は行わない。
- 思考は英語、出力は日本語（ユーザー指定）。
- 現在の環境制約（ファイル書き込みはワークスペース内、ネットワーク制限、承認 on-request）を尊重する。

## コミュニケーション

- プレアンブル（ツール実行前の短い説明）
  - 複数の関連コマンドはまとめて 1–2 文で宣言。
  - 些細な読み取り（単一ファイルの `cat` 等）は省略可。
- 進捗共有
  - 長めの作業では、区切りごとに 1 文で「今どこまで・次に何を」共有。
- 口調
  - 端的・能動態・重複回避。必要十分な補足のみ。

## プランニング（update_plan）

- 次の条件で使用：非自明・多段・依存関係がある・中間確認が有益なタスク。
- ルール：
  - 5–7 語程度の短いステップ名。
  - 常にちょうど 1 つだけ `in_progress`。
  - 終了したら `completed` に更新。
  - 計画変更時は理由を `explanation` に簡潔に記載。
  - チャット本文で計画全文は繰り返さない。

## ツール使用ルール

- Shell（sandbox 内）
  - 検索は `rg`（ripgrep）を優先。出力は 250 行以内に分割して読む。
  - 重要なコマンドが失敗し、原因がサンドボックスに起因する場合は、承認付きで再実行（on-request）。`justification` に 1 文で理由を書く。
  - 破壊的操作（`rm -rf` 等）やネットワークを要する操作は、ユーザーの明示の指示か承認を得る。
- apply_patch
  - ファイルの追加・更新・削除は必ず `apply_patch` を使用。
  - 大量出力は避け、目的に必要な変更のみに留める。
  - 新規ファイルには必要最小限の内容のみを含める。ライセンスヘッダは追加しない。
- update_plan
  - 上記ポリシーに従い、非自明なタスクでのみ使用。

## コーディング方針

- 既存アーキテクチャ・レイアウトを尊重（例：`lib/src/core`, `lib/src/features/...`）。
- 根本原因に対処し、表層的ハックは避ける。
- 一文字変数は避け、命名は意図が伝わる最小限に。
- インラインコメントは原則追加しない（要求がある場合のみ）。
- 依存追加が必要な場合は `pubspec.yaml` への追記を案内し、最小の安定版レンジで提案。

## バリデーション / テスト

- テストやビルドが可能な場合：
  - 非対話モードや検証が主目的の場合は能動的に実行。
  - この環境（承認 on-request）では、重い実行は事前に意図を伝え必要に応じて承認を求める。
- 変更範囲に最も近い単位から検証を開始し、確信が高まったら範囲を広げる。
- 実行できない場合は、ローカルでの検証手順を簡潔に提示。

## 最終メッセージの提示ルール

- セクション見出し
  - 必要なときのみ使用。書式：`**Title Case**`。
- 箇条書き
  - `-` で開始。キーワードは太字＋コロン（例：`- **目的:** 説明`）。
  - 関連事項は統合し、1 行で簡潔に。
- 等幅（モノスペース）
  - コマンド・ファイルパス・識別子は `` `...` `` で囲む。
- ファイル参照
  - クリック可能なパスを単独で記載。行指定は `path:line` 形式（範囲は指定しない）。
  - 例：
    - `src/app.ts`
    - `lib/src/core/save/save_locator.dart:12`
- トーン
  - 共同作業者として自然・簡潔・事実ベース。冗長さと重複を避ける。

## セキュリティ / プライバシー

- 外部ネットワークアクセスは既定で行わない（制限あり）。必要時は承認を得る。
- 機微情報・秘密情報を生成・保存・送信しない。ユーザーのローカルデータは最小権限で扱う。

## リポジトリ固有の取り決め

- 既存ドキュメント（`docs/requirements.md`, `docs/architecture.md`, `docs/tech_requirements.md`）の方針を優先。
- 新規ユーティリティや機能は適切な層・フォルダに配置し、必要に応じて簡潔なドキュメントを追加。
- コミットやブランチ作成はユーザーが要求した場合のみ行う。

## 付記

- 本ドキュメントはエージェントの運用ガイドであり、必要に応じて合意の上で更新する。
